<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CMMC Study">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="CMMC Level 2 Study Guide - 110 Controls with Quiz Mode for CCA Exam Prep">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>CMMC Level 2 - Interactive Study Guide with Quiz Mode</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #1a1a2e;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sticky Sidebar */
        .sidebar {
            width: 300px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .sidebar h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            color: #4fc3f7;
        }
        
        .sidebar .subtitle {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 10px;
            margin-top: 20px;
        }
        
        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid #333;
            background: transparent;
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .mode-btn:hover {
            border-color: #4fc3f7;
            color: #4fc3f7;
        }
        
        .mode-btn.active {
            background: #4fc3f7;
            border-color: #4fc3f7;
            color: #1a1a2e;
        }
        
        .mode-btn .icon {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        /* Progress Section */
        .progress-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .progress-title {
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .progress-percent {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4fc3f7;
        }
        
        .progress-bar-container {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #29b6f6);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.75rem;
            color: #888;
        }
        
        .progress-stats span {
            color: #4fc3f7;
            font-weight: 600;
        }
        
        .reset-progress {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: transparent;
            border: 1px solid #444;
            color: #888;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .reset-progress:hover {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        /* Legend */
        .legend-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .legend-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .legend-item.active {
            border-color: currentColor;
            background: rgba(255,255,255,0.05);
        }
        
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .legend-text {
            font-size: 0.85rem;
        }
        
        /* Implementation type colors */
        .policy { background: #2E86AB; color: #2E86AB; }
        .config { background: #A23B72; color: #A23B72; }
        .software { background: #F18F01; color: #F18F01; }
        .hardware { background: #C73E1D; color: #C73E1D; }
        .mixed { background: linear-gradient(135deg, #3D5A80, #7B2D8E); color: #7B2D8E; }
        
        /* Search */
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
        }
        
        .search-box input::placeholder {
            color: #666;
        }
        
        .search-box input:focus {
            outline: 2px solid #4fc3f7;
            background: rgba(255,255,255,0.15);
        }
        
        /* Study filter */
        .study-filter {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
        }
        
        .study-filter-btn {
            flex: 1;
            padding: 8px 6px;
            border: 1px solid #333;
            background: transparent;
            color: #888;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
        }
        
        .study-filter-btn:hover {
            border-color: #4fc3f7;
            color: #4fc3f7;
        }
        
        .study-filter-btn.active {
            background: rgba(79, 195, 247, 0.2);
            border-color: #4fc3f7;
            color: #4fc3f7;
        }
        
        /* Stats */
        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.8rem;
        }
        
        .stat-value {
            color: #4fc3f7;
            font-weight: 600;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 300px;
            flex: 1;
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h2 {
            font-size: 2rem;
            color: #1a1a2e;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
        }
        
        /* Domain Sections */
        .domain {
            background: white;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .domain-header {
            padding: 18px 25px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: filter 0.2s;
        }
        
        .domain-header:hover {
            filter: brightness(1.1);
        }
        
        .domain-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .domain-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .domain-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .domain-progress {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .domain-chevron {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }
        
        .domain.collapsed .domain-chevron {
            transform: rotate(-90deg);
        }
        
        .domain.collapsed .domain-content {
            display: none;
        }
        
        /* Controls Table */
        .controls-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .controls-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            border-bottom: 2px solid #e9ecef;
        }
        
        .controls-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
        }
        
        .controls-table tr:hover {
            background: #f8fafc;
        }
        
        .controls-table tr.hidden {
            display: none;
        }
        
        .controls-table tr.studied {
            background: #f0fdf4;
        }
        
        .controls-table tr.studied:hover {
            background: #dcfce7;
        }
        
        .control-id {
            font-weight: 700;
            color: #1a1a2e;
            font-size: 0.95rem;
        }
        
        .control-name {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
        }
        
        .control-req {
            font-size: 0.85rem;
            color: #444;
            line-height: 1.5;
        }
        
        .control-meaning {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.5;
        }
        
        .impl-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
        }
        
        /* Checkbox styling */
        .study-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #10b981;
        }
        
        /* Domain Colors */
        .domain-ac .domain-header { background: linear-gradient(135deg, #2563EB, #1d4ed8); }
        .domain-at .domain-header { background: linear-gradient(135deg, #059669, #047857); }
        .domain-au .domain-header { background: linear-gradient(135deg, #7C3AED, #6d28d9); }
        .domain-cm .domain-header { background: linear-gradient(135deg, #DC2626, #b91c1c); }
        .domain-ia .domain-header { background: linear-gradient(135deg, #0891B2, #0e7490); }
        .domain-ir .domain-header { background: linear-gradient(135deg, #EA580C, #c2410c); }
        .domain-ma .domain-header { background: linear-gradient(135deg, #4F46E5, #4338ca); }
        .domain-mp .domain-header { background: linear-gradient(135deg, #BE185D, #9d174d); }
        .domain-ps .domain-header { background: linear-gradient(135deg, #0D9488, #0f766e); }
        .domain-pe .domain-header { background: linear-gradient(135deg, #9333EA, #7e22ce); }
        .domain-ra .domain-header { background: linear-gradient(135deg, #CA8A04, #a16207); }
        .domain-ca .domain-header { background: linear-gradient(135deg, #2563EB, #1d4ed8); }
        .domain-sc .domain-header { background: linear-gradient(135deg, #DC2626, #b91c1c); }
        .domain-si .domain-header { background: linear-gradient(135deg, #65A30D, #4d7c0f); }
        
        /* ==================== QUIZ MODE ==================== */
        .quiz-container {
            display: none;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .quiz-container.active {
            display: block;
        }
        
        .study-container.hidden {
            display: none;
        }
        
        .quiz-settings {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .quiz-settings h3 {
            margin-bottom: 20px;
            color: #1a1a2e;
        }
        
        .quiz-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .quiz-option {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .quiz-option:hover {
            border-color: #4fc3f7;
            background: #f0f9ff;
        }
        
        .quiz-option.selected {
            border-color: #2563EB;
            background: #eff6ff;
        }
        
        .quiz-option .icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .quiz-option .label {
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 4px;
        }
        
        .quiz-option .desc {
            font-size: 0.8rem;
            color: #666;
        }
        
        .start-quiz-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2563EB, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .start-quiz-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }
        
        /* Quiz Card */
        .quiz-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.1);
            text-align: center;
            display: none;
        }
        
        .quiz-card.active {
            display: block;
        }
        
        .quiz-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .quiz-progress-text {
            font-size: 0.9rem;
            color: #666;
        }
        
        .quiz-score {
            display: flex;
            gap: 20px;
        }
        
        .quiz-score-item {
            font-size: 0.9rem;
        }
        
        .quiz-score-item.correct {
            color: #10b981;
        }
        
        .quiz-score-item.incorrect {
            color: #ef4444;
        }
        
        .quiz-question-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        
        .quiz-question {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .quiz-question-sub {
            font-size: 1rem;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .quiz-answers {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .quiz-answer {
            padding: 18px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-size: 0.95rem;
            background: white;
        }
        
        .quiz-answer:hover:not(.disabled) {
            border-color: #4fc3f7;
            background: #f0f9ff;
        }
        
        .quiz-answer.selected {
            border-color: #2563EB;
            background: #eff6ff;
        }
        
        .quiz-answer.correct {
            border-color: #10b981;
            background: #d1fae5;
        }
        
        .quiz-answer.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
        }
        
        .quiz-answer.disabled {
            cursor: default;
        }
        
        .quiz-feedback {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }
        
        .quiz-feedback.show {
            display: block;
        }
        
        .quiz-feedback.correct {
            background: #d1fae5;
            color: #065f46;
        }
        
        .quiz-feedback.incorrect {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .quiz-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }
        
        .quiz-btn-primary {
            background: linear-gradient(135deg, #2563EB, #1d4ed8);
            color: white;
        }
        
        .quiz-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(37, 99, 235, 0.3);
        }
        
        .quiz-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .quiz-btn-secondary:hover {
            background: #e5e7eb;
        }
        
        /* Flashcard Mode */
        .flashcard {
            perspective: 1000px;
            height: 350px;
            cursor: pointer;
            margin-bottom: 25px;
        }
        
        .flashcard-inner {
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
        }
        
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }
        
        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .flashcard-back {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            transform: rotateY(180deg);
        }
        
        .flashcard-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.8;
            margin-bottom: 15px;
        }
        
        .flashcard-content {
            font-size: 1.3rem;
            text-align: center;
            line-height: 1.5;
        }
        
        .flashcard-hint {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 20px;
        }
        
        .flashcard-id {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        /* Quiz Results */
        .quiz-results {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            display: none;
        }
        
        .quiz-results.active {
            display: block;
        }
        
        .results-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .results-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 10px;
        }
        
        .results-score {
            font-size: 3rem;
            font-weight: 700;
            color: #2563EB;
            margin-bottom: 20px;
        }
        
        .results-message {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 30px;
        }
        
        .results-breakdown {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
        }
        
        .results-stat {
            text-align: center;
        }
        
        .results-stat-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .results-stat-label {
            font-size: 0.85rem;
            color: #888;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 260px;
            }
            .main-content {
                margin-left: 260px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                width: 100%;
                height: auto;
                max-height: 70vh;
                bottom: 60px;
                left: 0;
                right: 0;
                top: auto;
                border-radius: 20px 20px 0 0;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }
            
            .sidebar.open {
                transform: translateY(0);
            }
            
            .main-content {
                margin-left: 0;
                margin-bottom: 70px;
                padding: 15px;
            }
            
            .container {
                flex-direction: column;
            }
            
            .quiz-options {
                grid-template-columns: 1fr;
            }
            
            .header h2 {
                font-size: 1.5rem;
            }
            
            .quiz-card, .quiz-settings {
                padding: 20px;
            }
            
            .quiz-question {
                font-size: 1.1rem;
            }
            
            .flashcard {
                height: 280px;
            }
            
            .flashcard-content {
                font-size: 1rem;
            }
            
            .controls-table th,
            .controls-table td {
                padding: 10px 8px;
                font-size: 0.8rem;
            }
            
            .control-id {
                font-size: 0.85rem;
            }
            
            .control-name {
                font-size: 0.7rem;
            }
            
            .impl-badge {
                padding: 3px 8px;
                font-size: 0.65rem;
            }
            
            /* Hide some columns on mobile */
            .controls-table th:nth-child(3),
            .controls-table td:nth-child(3) {
                display: none;
            }
        }
        
        /* Mobile Bottom Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a2e;
            padding: 10px 20px;
            z-index: 1001;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
                justify-content: space-around;
                align-items: center;
            }
        }
        
        .mobile-nav-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 0.75rem;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        .mobile-nav-btn.active {
            color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
        }
        
        .mobile-nav-btn .icon {
            font-size: 1.3rem;
        }
        
        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 60px;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h1>CMMC Level 2</h1>
            <p class="subtitle">110 Controls Study Guide</p>
            
            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <button class="mode-btn active" id="studyModeBtn" onclick="setMode('study')">
                    <span class="icon">üìö</span>
                    Study
                </button>
                <button class="mode-btn" id="quizModeBtn" onclick="setMode('quiz')">
                    <span class="icon">üéØ</span>
                    Quiz
                </button>
            </div>
            
            <!-- Progress Section -->
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-title">Study Progress</span>
                    <span class="progress-percent" id="progressPercent">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-stats">
                    <span><span id="studiedCount">0</span> studied</span>
                    <span><span id="remainingCount">110</span> remaining</span>
                </div>
                <button class="reset-progress" onclick="resetProgress()">‚Ü∫ Reset Progress</button>
            </div>
            
            <!-- Study Mode Controls -->
            <div id="studyControls">
                <div class="section-title">Search</div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Search controls...">
                </div>
                
                <div class="section-title">Show</div>
                <div class="study-filter">
                    <button class="study-filter-btn active" data-study-filter="all" onclick="setStudyFilter('all')">All</button>
                    <button class="study-filter-btn" data-study-filter="unstudied" onclick="setStudyFilter('unstudied')">üìñ To Study</button>
                    <button class="study-filter-btn" data-study-filter="studied" onclick="setStudyFilter('studied')">‚úÖ Studied</button>
                </div>
                
                <div class="section-title">Filter by Type</div>
                
                <div class="legend-item active" data-filter="all" onclick="setTypeFilter('all')">
                    <div class="legend-color" style="background: linear-gradient(135deg, #2E86AB, #A23B72, #F18F01, #C73E1D);"></div>
                    <div class="legend-text">All Types (110)</div>
                </div>
                
                <div class="legend-item" data-filter="policy" onclick="setTypeFilter('policy')">
                    <div class="legend-color policy"></div>
                    <div class="legend-text">Policy/Process</div>
                </div>
                
                <div class="legend-item" data-filter="config" onclick="setTypeFilter('config')">
                    <div class="legend-color config"></div>
                    <div class="legend-text">Configuration</div>
                </div>
                
                <div class="legend-item" data-filter="software" onclick="setTypeFilter('software')">
                    <div class="legend-color software"></div>
                    <div class="legend-text">Software</div>
                </div>
                
                <div class="legend-item" data-filter="hardware" onclick="setTypeFilter('hardware')">
                    <div class="legend-color hardware"></div>
                    <div class="legend-text">Hardware</div>
                </div>
                
                <div class="legend-item" data-filter="mixed" onclick="setTypeFilter('mixed')">
                    <div class="legend-color mixed"></div>
                    <div class="legend-text">Mixed/Combo</div>
                </div>
                
                <div class="stats">
                    <div class="stat-item">
                        <span>Showing</span>
                        <span class="stat-value" id="showingCount">110</span>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Mode Controls -->
            <div id="quizControls" style="display: none;">
                <div class="section-title">Quiz Stats</div>
                <div class="progress-section">
                    <div class="stat-item">
                        <span>Questions</span>
                        <span class="stat-value" id="quizQuestionsCount">0 / 0</span>
                    </div>
                    <div class="stat-item">
                        <span>Correct</span>
                        <span class="stat-value" style="color: #10b981" id="quizCorrectCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Incorrect</span>
                        <span class="stat-value" style="color: #ef4444" id="quizIncorrectCount">0</span>
                    </div>
                </div>
                
                <button class="quiz-btn quiz-btn-secondary" style="width: 100%; margin-top: 15px;" onclick="endQuiz()">
                    ‚úï End Quiz
                </button>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Study Mode -->
            <div id="studyContainer" class="study-container">
                <div class="header">
                    <h2>CMMC Level 2 Controls Reference</h2>
                    <p>Check off controls as you study them ‚Ä¢ Filter by type or study status</p>
                </div>
                
                <div id="domainsContainer"></div>
            </div>
            
            <!-- Quiz Mode -->
            <div id="quizContainer" class="quiz-container">
                <!-- Quiz Settings -->
                <div class="quiz-settings" id="quizSettings">
                    <h3>üéØ Choose Your Quiz Mode</h3>
                    <div class="quiz-options">
                        <div class="quiz-option selected" data-quiz-type="multiple-choice" onclick="selectQuizType('multiple-choice')">
                            <div class="icon">üìù</div>
                            <div class="label">Multiple Choice</div>
                            <div class="desc">Match controls to their requirements</div>
                        </div>
                        <div class="quiz-option" data-quiz-type="flashcard" onclick="selectQuizType('flashcard')">
                            <div class="icon">üÉè</div>
                            <div class="label">Flashcards</div>
                            <div class="desc">Flip to reveal answers</div>
                        </div>
                        <div class="quiz-option" data-quiz-type="type-match" onclick="selectQuizType('type-match')">
                            <div class="icon">üè∑Ô∏è</div>
                            <div class="label">Type Match</div>
                            <div class="desc">Match controls to implementation type</div>
                        </div>
                        <div class="quiz-option" data-quiz-type="domain-match" onclick="selectQuizType('domain-match')">
                            <div class="icon">üìÇ</div>
                            <div class="label">Domain Match</div>
                            <div class="desc">Identify which domain a control belongs to</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div class="section-title" style="color: #666; margin-top: 0;">Number of Questions</div>
                        <div class="study-filter" style="margin-bottom: 0;">
                            <button class="study-filter-btn" data-q-count="10" onclick="setQuestionCount(10)">10</button>
                            <button class="study-filter-btn active" data-q-count="20" onclick="setQuestionCount(20)">20</button>
                            <button class="study-filter-btn" data-q-count="50" onclick="setQuestionCount(50)">50</button>
                            <button class="study-filter-btn" data-q-count="110" onclick="setQuestionCount(110)">All 110</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div class="section-title" style="color: #666; margin-top: 0;">Focus On</div>
                        <div class="study-filter" style="margin-bottom: 0;">
                            <button class="study-filter-btn active" data-focus="all" onclick="setQuizFocus('all')">All Controls</button>
                            <button class="study-filter-btn" data-focus="unstudied" onclick="setQuizFocus('unstudied')">Unstudied Only</button>
                        </div>
                    </div>
                    
                    <button class="start-quiz-btn" onclick="startQuiz()">
                        Start Quiz ‚Üí
                    </button>
                </div>
                
                <!-- Quiz Card (Multiple Choice) -->
                <div class="quiz-card" id="quizCard">
                    <div class="quiz-progress">
                        <span class="quiz-progress-text">Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span></span>
                        <div class="quiz-score">
                            <span class="quiz-score-item correct">‚úì <span id="correctScore">0</span></span>
                            <span class="quiz-score-item incorrect">‚úó <span id="incorrectScore">0</span></span>
                        </div>
                    </div>
                    
                    <div class="quiz-question-label" id="questionLabel">What control is this?</div>
                    <div class="quiz-question" id="questionText">Loading...</div>
                    <div class="quiz-question-sub" id="questionSub"></div>
                    
                    <div class="quiz-answers" id="quizAnswers"></div>
                    
                    <div class="quiz-feedback" id="quizFeedback"></div>
                    
                    <div id="quizActions">
                        <button class="quiz-btn quiz-btn-primary" id="nextBtn" onclick="nextQuestion()" style="display: none;">
                            Next Question ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Flashcard -->
                <div class="quiz-card" id="flashcardCard">
                    <div class="quiz-progress">
                        <span class="quiz-progress-text">Card <span id="fcCurrentQuestion">1</span> of <span id="fcTotalQuestions">20</span></span>
                    </div>
                    
                    <div class="flashcard" id="flashcard" onclick="flipCard()">
                        <div class="flashcard-inner">
                            <div class="flashcard-front">
                                <div class="flashcard-id" id="fcControlId">3.1.1</div>
                                <div class="flashcard-label">Control</div>
                                <div class="flashcard-content" id="fcFront">Loading...</div>
                                <div class="flashcard-hint">Click to flip</div>
                            </div>
                            <div class="flashcard-back">
                                <div class="flashcard-label">What It Means</div>
                                <div class="flashcard-content" id="fcBack">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <button class="quiz-btn quiz-btn-secondary" onclick="markFlashcard(false)">
                            ‚ùå Needs Review
                        </button>
                        <button class="quiz-btn quiz-btn-primary" onclick="markFlashcard(true)">
                            ‚úÖ Got It!
                        </button>
                    </div>
                </div>
                
                <!-- Quiz Results -->
                <div class="quiz-results" id="quizResults">
                    <div class="results-icon" id="resultsIcon">üéâ</div>
                    <div class="results-title">Quiz Complete!</div>
                    <div class="results-score" id="resultsScore">85%</div>
                    <div class="results-message" id="resultsMessage">Great job! Keep studying!</div>
                    
                    <div class="results-breakdown">
                        <div class="results-stat">
                            <div class="results-stat-value" style="color: #10b981" id="resultsCorrect">17</div>
                            <div class="results-stat-label">Correct</div>
                        </div>
                        <div class="results-stat">
                            <div class="results-stat-value" style="color: #ef4444" id="resultsIncorrect">3</div>
                            <div class="results-stat-label">Incorrect</div>
                        </div>
                        <div class="results-stat">
                            <div class="results-stat-value" style="color: #2563EB" id="resultsTotal">20</div>
                            <div class="results-stat-label">Total</div>
                        </div>
                    </div>
                    
                    <button class="quiz-btn quiz-btn-primary" onclick="restartQuiz()">
                        Try Again
                    </button>
                    <button class="quiz-btn quiz-btn-secondary" onclick="setMode('study')">
                        Back to Study Mode
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <button class="mobile-nav-btn active" onclick="mobileSetMode('study')" id="mobileStudyBtn">
            <span class="icon">üìö</span>
            Study
        </button>
        <button class="mobile-nav-btn" onclick="mobileSetMode('quiz')" id="mobileQuizBtn">
            <span class="icon">üéØ</span>
            Quiz
        </button>
        <button class="mobile-nav-btn" onclick="toggleMobileSidebar()" id="mobileMenuBtn">
            <span class="icon">‚öôÔ∏è</span>
            Menu
        </button>
    </nav>
    
    <!-- Overlay for mobile sidebar -->
    <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

    <script>
        // ==================== CONTROL DATA ====================
        const CONTROLS = {
            'ACCESS CONTROL (AC)': {
                id: 'ac',
                count: 22,
                controls: [
                    { id: '3.1.1', name: 'Authorized Access Control', type: 'policy', 
                      req: 'Limit information system access to authorized users, processes acting on behalf of authorized users, or devices.',
                      meaning: 'Restrict who has access to your business computers and network. Maintain lists of authorized users and devices.' },
                    { id: '3.1.2', name: 'Transaction & Function Control', type: 'config',
                      req: 'Limit information system access to the types of transactions and functions that authorized users are permitted to execute.',
                      meaning: 'Limit access to applications and data based on users\' roles and responsibilities (create, read, update, delete).' },
                    { id: '3.1.3', name: 'Control CUI Flow', type: 'mixed',
                      req: 'Control the flow of CUI in accordance with approved authorizations.',
                      meaning: 'Use firewalls and proxies to control information transfers. Encrypt CUI transmitted via email.' },
                    { id: '3.1.4', name: 'Separation of Duties', type: 'policy',
                      req: 'Separate the duties of individuals to reduce the risk of malevolent activity without collusion.',
                      meaning: 'Divide functions among different individuals so no single person can compromise multiple system areas.' },
                    { id: '3.1.5', name: 'Least Privilege', type: 'config',
                      req: 'Employ the principle of least privilege, including for specific security functions and privileged accounts.',
                      meaning: 'Grant only enough privileges to allow users to perform their duties. Regularly review access rights.' },
                    { id: '3.1.6', name: 'Non-Privileged Account Use', type: 'policy',
                      req: 'Use non-privileged accounts or roles when accessing nonsecurity functions.',
                      meaning: 'Admins should use standard accounts for everyday tasks; only use privileged accounts when necessary.' },
                    { id: '3.1.7', name: 'Privileged Functions', type: 'config',
                      req: 'Prevent non-privileged users from executing privileged functions and capture the execution in audit logs.',
                      meaning: 'Block standard users from admin functions. Log all privileged actions for accountability.' },
                    { id: '3.1.8', name: 'Unsuccessful Logon Attempts', type: 'config',
                      req: 'Limit unsuccessful logon attempts.',
                      meaning: 'Lock accounts after a set number of failed login attempts to prevent brute force attacks.' },
                    { id: '3.1.9', name: 'Privacy & Security Notices', type: 'config',
                      req: 'Provide privacy and security notices consistent with applicable CUI rules.',
                      meaning: 'Display login banners warning users about authorized use, monitoring, and consequences.' },
                    { id: '3.1.10', name: 'Session Lock', type: 'config',
                      req: 'Use session lock with pattern-hiding displays to prevent access and viewing of data after inactivity.',
                      meaning: 'Auto-lock screens after inactivity (e.g., 15 min). Require password to unlock.' },
                    { id: '3.1.11', name: 'Session Termination', type: 'config',
                      req: 'Terminate (automatically) a user session after a defined condition.',
                      meaning: 'Auto-logoff idle sessions after defined periods. Force re-authentication.' },
                    { id: '3.1.12', name: 'Control Remote Access', type: 'mixed',
                      req: 'Monitor and control remote access sessions.',
                      meaning: 'Monitor VPN connections. Log who accesses remotely and what they access.' },
                    { id: '3.1.13', name: 'Remote Access Confidentiality', type: 'software',
                      req: 'Employ cryptographic mechanisms to protect the confidentiality of remote access sessions.',
                      meaning: 'Use encrypted VPN connections with FIPS-validated encryption for all remote access.' },
                    { id: '3.1.14', name: 'Remote Access Routing', type: 'config',
                      req: 'Route remote access via managed access control points.',
                      meaning: 'Route all remote connections through a limited number of controlled access points (e.g., VPN concentrator).' },
                    { id: '3.1.15', name: 'Privileged Remote Access', type: 'policy',
                      req: 'Authorize remote execution of privileged commands and remote access to security-relevant information.',
                      meaning: 'Document and limit which admins can execute privileged commands remotely.' },
                    { id: '3.1.16', name: 'Wireless Access Authorization', type: 'config',
                      req: 'Authorize wireless access prior to allowing such connections.',
                      meaning: 'Require approval before granting wireless network access. Document authorization requirements.' },
                    { id: '3.1.17', name: 'Wireless Access Protection', type: 'config',
                      req: 'Protect wireless access using authentication and encryption.',
                      meaning: 'Use WPA2/WPA3 with FIPS-validated encryption. Require authentication.' },
                    { id: '3.1.18', name: 'Mobile Device Connection', type: 'mixed',
                      req: 'Control connection of mobile devices.',
                      meaning: 'Identify devices that handle CUI. Authorize and monitor mobile device connections.' },
                    { id: '3.1.19', name: 'Encrypt CUI on Mobile', type: 'software',
                      req: 'Encrypt CUI on mobile devices and mobile computing platforms.',
                      meaning: 'Use full-disk encryption (e.g., BitLocker) on laptops and mobile devices containing CUI.' },
                    { id: '3.1.20', name: 'External Connections', type: 'policy',
                      req: 'Verify and control/limit connections to and use of external information systems.',
                      meaning: 'Control connections to external systems. Limit use of personal devices for CUI access.' },
                    { id: '3.1.21', name: 'Portable Storage Use', type: 'policy',
                      req: 'Limit use of portable storage devices on external systems.',
                      meaning: 'Restrict use of USB drives. Only allow company-owned, encrypted storage devices.' },
                    { id: '3.1.22', name: 'Control Public Information', type: 'policy',
                      req: 'Control information posted or processed on publicly accessible information systems.',
                      meaning: 'Do not post CUI on public websites. Review content before public posting.' },
                ]
            },
            'AWARENESS AND TRAINING (AT)': {
                id: 'at',
                count: 3,
                controls: [
                    { id: '3.2.1', name: 'Role-Based Risk Awareness', type: 'policy',
                      req: 'Ensure that managers, systems administrators, and users are made aware of security risks.',
                      meaning: 'Provide security awareness training to all personnel at hire and annually thereafter.' },
                    { id: '3.2.2', name: 'Role-Based Training', type: 'policy',
                      req: 'Ensure that personnel are trained to carry out their assigned information security-related duties.',
                      meaning: 'Train IT staff, admins, and security personnel on their specific security responsibilities.' },
                    { id: '3.2.3', name: 'Insider Threat Awareness', type: 'policy',
                      req: 'Provide security awareness training on recognizing and reporting potential indicators of insider threat.',
                      meaning: 'Train employees to recognize and report suspicious behavior, unauthorized access attempts.' },
                ]
            },
            'AUDIT AND ACCOUNTABILITY (AU)': {
                id: 'au',
                count: 9,
                controls: [
                    { id: '3.3.1', name: 'System Auditing', type: 'config',
                      req: 'Create and retain system audit logs and records to enable monitoring, analysis, investigation, and reporting.',
                      meaning: 'Enable logging on all systems. Capture login events, file access, configuration changes.' },
                    { id: '3.3.2', name: 'User Accountability', type: 'config',
                      req: 'Ensure that the actions of individual system users can be uniquely traced to those users.',
                      meaning: 'Assign unique user accounts. No shared accounts. Enable user ID logging.' },
                    { id: '3.3.3', name: 'Event Review', type: 'policy',
                      req: 'Review and update logged events.',
                      meaning: 'Periodically review audit logs. Define which events to log and review frequency.' },
                    { id: '3.3.4', name: 'Audit Failure Alerting', type: 'config',
                      req: 'Alert in the event of an audit logging process failure.',
                      meaning: 'Configure alerts when logging fails or storage is near capacity.' },
                    { id: '3.3.5', name: 'Audit Correlation', type: 'software',
                      req: 'Correlate audit record review, analysis, and reporting processes for investigation and response.',
                      meaning: 'Use SIEM tools to correlate logs from multiple sources for security analysis.' },
                    { id: '3.3.6', name: 'Reduction & Reporting', type: 'software',
                      req: 'Provide audit record reduction and report generation to support on-demand analysis.',
                      meaning: 'Use tools to filter, summarize, and report on audit data. Generate security reports.' },
                    { id: '3.3.7', name: 'Authoritative Time Source', type: 'config',
                      req: 'Provide a system capability that compares and synchronizes internal system clocks.',
                      meaning: 'Sync all system clocks to NTP server. Ensures accurate timestamps for audit logs.' },
                    { id: '3.3.8', name: 'Audit Protection', type: 'config',
                      req: 'Protect audit information and audit logging tools from unauthorized access, modification, and deletion.',
                      meaning: 'Restrict access to audit logs to security personnel only. Use write-once storage.' },
                    { id: '3.3.9', name: 'Audit Management', type: 'policy',
                      req: 'Limit management of audit logging functionality to a subset of privileged users.',
                      meaning: 'Only designated security admins can modify audit configurations.' },
                ]
            },
            'CONFIGURATION MANAGEMENT (CM)': {
                id: 'cm',
                count: 9,
                controls: [
                    { id: '3.4.1', name: 'System Baselining', type: 'policy',
                      req: 'Establish and maintain baseline configurations and inventories of organizational systems.',
                      meaning: 'Create standard configurations for computers/servers. Maintain hardware/software inventory.' },
                    { id: '3.4.2', name: 'Security Configuration Enforcement', type: 'config',
                      req: 'Establish and enforce security configuration settings for information technology products.',
                      meaning: 'Use security configuration guides (STIGs, CIS Benchmarks). Prevent unauthorized changes.' },
                    { id: '3.4.3', name: 'System Change Management', type: 'policy',
                      req: 'Track, review, approve or disapprove, and log changes to organizational systems.',
                      meaning: 'Document all system changes. Require approval before implementing changes.' },
                    { id: '3.4.4', name: 'Security Impact Analysis', type: 'policy',
                      req: 'Analyze the security impact of changes prior to implementation.',
                      meaning: 'Evaluate how proposed changes affect security before implementing them.' },
                    { id: '3.4.5', name: 'Access Restrictions for Change', type: 'config',
                      req: 'Define, document, approve, and enforce physical and logical access restrictions associated with changes.',
                      meaning: 'Limit who can make system changes. Require authentication for configuration changes.' },
                    { id: '3.4.6', name: 'Least Functionality', type: 'config',
                      req: 'Employ the principle of least functionality by configuring systems to provide only essential capabilities.',
                      meaning: 'Disable unnecessary services, ports, and protocols. Remove unused software.' },
                    { id: '3.4.7', name: 'Nonessential Functionality', type: 'config',
                      req: 'Restrict, disable, or prevent the use of nonessential programs, functions, ports, protocols, and services.',
                      meaning: 'Block unnecessary network ports. Disable unused system services.' },
                    { id: '3.4.8', name: 'Application Execution Policy', type: 'mixed',
                      req: 'Apply deny-by-exception (blacklisting) policy to prevent the use of unauthorized software.',
                      meaning: 'Use application whitelisting/blacklisting to control what software can run.' },
                    { id: '3.4.9', name: 'User-Installed Software', type: 'policy',
                      req: 'Control and monitor user-installed software.',
                      meaning: 'Restrict users from installing software. Monitor for unauthorized installations.' },
                ]
            },
            'IDENTIFICATION AND AUTHENTICATION (IA)': {
                id: 'ia',
                count: 11,
                controls: [
                    { id: '3.5.1', name: 'Identification', type: 'config',
                      req: 'Identify system users, processes acting on behalf of users, and devices.',
                      meaning: 'Assign unique identifiers to all users, processes, and devices accessing systems.' },
                    { id: '3.5.2', name: 'Authentication', type: 'config',
                      req: 'Authenticate (or verify) the identities of users, processes, or devices, as a prerequisite to allowing access.',
                      meaning: 'Require passwords/credentials before granting system access.' },
                    { id: '3.5.3', name: 'Multifactor Authentication', type: 'mixed',
                      req: 'Use multifactor authentication for local and network access to privileged accounts and for network access to non-privileged accounts.',
                      meaning: 'Implement MFA (password + phone/token) for admin and remote access.' },
                    { id: '3.5.4', name: 'Replay-Resistant Authentication', type: 'config',
                      req: 'Employ replay-resistant authentication mechanisms for network access.',
                      meaning: 'Use authentication protocols that prevent replay attacks (Kerberos, TLS, one-time passwords).' },
                    { id: '3.5.5', name: 'Identifier Reuse', type: 'policy',
                      req: 'Prevent reuse of identifiers for a defined period.',
                      meaning: 'Don\'t reassign usernames to new users for a defined period after account deletion.' },
                    { id: '3.5.6', name: 'Identifier Handling', type: 'policy',
                      req: 'Disable identifiers after a defined period of inactivity.',
                      meaning: 'Disable accounts after 90 days of inactivity. Disable accounts of terminated users immediately.' },
                    { id: '3.5.7', name: 'Password Complexity', type: 'config',
                      req: 'Enforce a minimum password complexity and change of characters when new passwords are created.',
                      meaning: 'Require 12+ characters, mixed case, numbers, symbols. Prevent simple passwords.' },
                    { id: '3.5.8', name: 'Password Reuse', type: 'config',
                      req: 'Prohibit password reuse for a specified number of generations.',
                      meaning: 'Prevent reuse of previous 24 passwords. Enforce password history.' },
                    { id: '3.5.9', name: 'Temporary Passwords', type: 'policy',
                      req: 'Allow temporary password use for system logons with an immediate change to a permanent password.',
                      meaning: 'Force users to change temporary/initial passwords immediately upon first login.' },
                    { id: '3.5.10', name: 'Cryptographically-Protected Passwords', type: 'config',
                      req: 'Store and transmit only cryptographically-protected passwords.',
                      meaning: 'Hash passwords in databases. Use encrypted connections for authentication.' },
                    { id: '3.5.11', name: 'Obscure Feedback', type: 'config',
                      req: 'Obscure feedback of authentication information.',
                      meaning: 'Mask password entry with dots/asterisks. Don\'t display passwords on screen.' },
                ]
            },
            'INCIDENT RESPONSE (IR)': {
                id: 'ir',
                count: 3,
                controls: [
                    { id: '3.6.1', name: 'Incident Handling', type: 'policy',
                      req: 'Establish an operational incident-handling capability including preparation, detection, analysis, containment, recovery, and user response.',
                      meaning: 'Create incident response procedures. Establish IR team and contact lists.' },
                    { id: '3.6.2', name: 'Incident Reporting', type: 'policy',
                      req: 'Track, document, and report incidents to designated officials and/or authorities.',
                      meaning: 'Document all incidents. Report to management and authorities as required.' },
                    { id: '3.6.3', name: 'Incident Response Testing', type: 'policy',
                      req: 'Test the organizational incident response capability.',
                      meaning: 'Conduct tabletop exercises or simulations to test IR procedures annually.' },
                ]
            },
            'MAINTENANCE (MA)': {
                id: 'ma',
                count: 6,
                controls: [
                    { id: '3.7.1', name: 'Perform Maintenance', type: 'policy',
                      req: 'Perform maintenance on organizational systems.',
                      meaning: 'Conduct regular system maintenance including patching and updates.' },
                    { id: '3.7.2', name: 'System Maintenance Control', type: 'policy',
                      req: 'Provide controls on the tools, techniques, mechanisms, and personnel used to conduct system maintenance.',
                      meaning: 'Control and monitor maintenance tools. Supervise maintenance personnel.' },
                    { id: '3.7.3', name: 'Equipment Sanitization', type: 'policy',
                      req: 'Ensure equipment removed for off-site maintenance is sanitized of any CUI.',
                      meaning: 'Remove all CUI from equipment before sending for external repair.' },
                    { id: '3.7.4', name: 'Media Inspection', type: 'software',
                      req: 'Check media containing diagnostic and test programs for malicious code before use.',
                      meaning: 'Scan all removable media (USB, CDs) for malware before connecting to systems.' },
                    { id: '3.7.5', name: 'Nonlocal Maintenance', type: 'mixed',
                      req: 'Require multifactor authentication to establish nonlocal maintenance sessions and terminate when complete.',
                      meaning: 'Require MFA for remote maintenance. Disconnect sessions when work is complete.' },
                    { id: '3.7.6', name: 'Maintenance Personnel', type: 'policy',
                      req: 'Supervise the maintenance activities of maintenance personnel without required access authorization.',
                      meaning: 'Escort and monitor vendor/contractor maintenance personnel. Use temporary accounts.' },
                ]
            },
            'MEDIA PROTECTION (MP)': {
                id: 'mp',
                count: 9,
                controls: [
                    { id: '3.8.1', name: 'Media Protection', type: 'policy',
                      req: 'Protect (i.e., physically control and securely store) system media containing CUI.',
                      meaning: 'Store CUI media in locked cabinets/safes. Control access to storage areas.' },
                    { id: '3.8.2', name: 'Media Access', type: 'policy',
                      req: 'Limit access to CUI on system media to authorized users.',
                      meaning: 'Restrict who can access CUI on removable media. Log access to sensitive media.' },
                    { id: '3.8.3', name: 'Media Disposal', type: 'policy',
                      req: 'Sanitize or destroy system media containing CUI before disposal or release for reuse.',
                      meaning: 'Wipe or physically destroy drives/media before disposal. Document destruction.' },
                    { id: '3.8.4', name: 'Media Markings', type: 'policy',
                      req: 'Mark media with necessary CUI markings and distribution limitations.',
                      meaning: 'Label CUI media with appropriate markings. Include handling instructions.' },
                    { id: '3.8.5', name: 'Media Accountability', type: 'policy',
                      req: 'Control access to media containing CUI and maintain accountability during transport.',
                      meaning: 'Track CUI media. Sign out/in media. Document chain of custody during transport.' },
                    { id: '3.8.6', name: 'Portable Storage Encryption', type: 'software',
                      req: 'Implement cryptographic mechanisms to protect the confidentiality of CUI stored on digital media.',
                      meaning: 'Encrypt USB drives, portable drives containing CUI using FIPS-validated encryption.' },
                    { id: '3.8.7', name: 'Removeable Media', type: 'mixed',
                      req: 'Control the use of removable media on system components.',
                      meaning: 'Restrict USB ports. Only allow authorized, encrypted removable media.' },
                    { id: '3.8.8', name: 'Shared Media', type: 'policy',
                      req: 'Prohibit the use of portable storage devices when such devices have no identifiable owner.',
                      meaning: 'Don\'t allow "found" USB drives. Only use company-issued, labeled storage devices.' },
                    { id: '3.8.9', name: 'Protect Backups', type: 'mixed',
                      req: 'Protect the confidentiality of backup CUI at storage locations.',
                      meaning: 'Encrypt backups containing CUI. Secure backup storage locations.' },
                ]
            },
            'PERSONNEL SECURITY (PS)': {
                id: 'ps',
                count: 2,
                controls: [
                    { id: '3.9.1', name: 'Screen Individuals', type: 'policy',
                      req: 'Screen individuals prior to authorizing access to organizational systems containing CUI.',
                      meaning: 'Conduct background checks before granting CUI access. Verify references.' },
                    { id: '3.9.2', name: 'Personnel Actions', type: 'policy',
                      req: 'Ensure that CUI and systems are protected during and after personnel actions such as terminations.',
                      meaning: 'Disable accounts upon termination. Retrieve badges/equipment. Revoke access on transfer.' },
                ]
            },
            'PHYSICAL PROTECTION (PE)': {
                id: 'pe',
                count: 6,
                controls: [
                    { id: '3.10.1', name: 'Limit Physical Access', type: 'hardware',
                      req: 'Limit physical access to organizational systems, equipment, and operating environments to authorized individuals.',
                      meaning: 'Use badge access, locks, guards. Restrict access to server rooms and sensitive areas.' },
                    { id: '3.10.2', name: 'Monitor Facility', type: 'hardware',
                      req: 'Protect and monitor the physical facility and support infrastructure for organizational systems.',
                      meaning: 'Use cameras, alarms, guards. Protect power, network cabling from tampering.' },
                    { id: '3.10.3', name: 'Escort Visitors', type: 'policy',
                      req: 'Escort visitors and monitor visitor activity.',
                      meaning: 'Require escort for all visitors. Monitor and log visitor activities.' },
                    { id: '3.10.4', name: 'Physical Access Logs', type: 'policy',
                      req: 'Maintain audit logs of physical access.',
                      meaning: 'Use sign-in sheets or electronic logs at secure areas. Retain logs for review.' },
                    { id: '3.10.5', name: 'Manage Physical Access', type: 'hardware',
                      req: 'Control and manage physical access devices.',
                      meaning: 'Track keys, badges, access cards. Revoke access devices when no longer needed.' },
                    { id: '3.10.6', name: 'Alternative Work Sites', type: 'policy',
                      req: 'Enforce safeguarding measures for CUI at alternate work sites.',
                      meaning: 'Define security requirements for home offices. Ensure CUI protection at all locations.' },
                ]
            },
            'RISK ASSESSMENT (RA)': {
                id: 'ra',
                count: 3,
                controls: [
                    { id: '3.11.1', name: 'Risk Assessments', type: 'policy',
                      req: 'Periodically assess the risk to organizational operations, organizational assets, and individuals.',
                      meaning: 'Conduct annual risk assessments. Document threats, vulnerabilities, and impacts.' },
                    { id: '3.11.2', name: 'Vulnerability Scan', type: 'software',
                      req: 'Scan for vulnerabilities in organizational systems and applications periodically.',
                      meaning: 'Run vulnerability scans regularly. Scan after major changes or new vulnerability announcements.' },
                    { id: '3.11.3', name: 'Vulnerability Remediation', type: 'policy',
                      req: 'Remediate vulnerabilities in accordance with risk assessments.',
                      meaning: 'Patch and fix vulnerabilities based on risk priority. Track remediation progress.' },
                ]
            },
            'SECURITY ASSESSMENT (CA)': {
                id: 'ca',
                count: 4,
                controls: [
                    { id: '3.12.1', name: 'Security Control Assessment', type: 'policy',
                      req: 'Periodically assess the security controls in organizational systems to determine effectiveness.',
                      meaning: 'Conduct annual security assessments. Test controls for effectiveness.' },
                    { id: '3.12.2', name: 'Plan of Action', type: 'policy',
                      req: 'Develop and implement plans of action designed to correct deficiencies.',
                      meaning: 'Create POA&M documents to track security deficiencies and remediation plans.' },
                    { id: '3.12.3', name: 'Security Control Monitoring', type: 'mixed',
                      req: 'Monitor security controls on an ongoing basis to ensure continued effectiveness.',
                      meaning: 'Continuously monitor controls. Use automated tools for ongoing assessment.' },
                    { id: '3.12.4', name: 'System Security Plan', type: 'policy',
                      req: 'Develop, document, and periodically update system security plans.',
                      meaning: 'Create and maintain SSP documenting security controls. Review/update annually.' },
                ]
            },
            'SYSTEM AND COMMUNICATIONS PROTECTION (SC)': {
                id: 'sc',
                count: 16,
                controls: [
                    { id: '3.13.1', name: 'Boundary Protection', type: 'hardware',
                      req: 'Monitor, control, and protect organizational communications at external and key internal boundaries.',
                      meaning: 'Deploy firewalls, IDS/IPS at network boundaries. Monitor traffic in and out.' },
                    { id: '3.13.2', name: 'Security Engineering', type: 'policy',
                      req: 'Employ architectural designs, software development techniques, and systems engineering principles that promote security.',
                      meaning: 'Design security into systems from the start. Use defense-in-depth principles.' },
                    { id: '3.13.3', name: 'Role Separation', type: 'config',
                      req: 'Separate user functionality from system management functionality.',
                      meaning: 'Separate admin interfaces from user interfaces. Don\'t mix admin and user functions.' },
                    { id: '3.13.4', name: 'Shared Resource Control', type: 'config',
                      req: 'Prevent unauthorized and unintended information transfer via shared system resources.',
                      meaning: 'Configure systems to prevent data leakage through shared memory, temp files.' },
                    { id: '3.13.5', name: 'Public-Access System Separation', type: 'hardware',
                      req: 'Implement subnetworks for publicly accessible system components that are separated from internal networks.',
                      meaning: 'Place web servers in DMZ. Separate public-facing systems from internal network.' },
                    { id: '3.13.6', name: 'Network Communication by Exception', type: 'config',
                      req: 'Deny network communications traffic by default and allow by exception.',
                      meaning: 'Configure firewalls to deny-all by default. Only allow specifically approved traffic.' },
                    { id: '3.13.7', name: 'Split Tunneling', type: 'config',
                      req: 'Prevent remote devices from simultaneously establishing non-remote connections and communicating via other connections.',
                      meaning: 'Disable split tunneling on VPN clients. Force all traffic through VPN when connected.' },
                    { id: '3.13.8', name: 'Data in Transit', type: 'software',
                      req: 'Implement cryptographic mechanisms to prevent unauthorized disclosure of CUI during transmission.',
                      meaning: 'Use TLS/HTTPS for web traffic. Encrypt email containing CUI.' },
                    { id: '3.13.9', name: 'Connections Termination', type: 'config',
                      req: 'Terminate network connections associated with sessions at the end or after inactivity.',
                      meaning: 'Configure session timeouts. Terminate idle connections automatically.' },
                    { id: '3.13.10', name: 'Key Management', type: 'policy',
                      req: 'Establish and manage cryptographic keys for cryptography employed in organizational systems.',
                      meaning: 'Create key management procedures. Protect, rotate, and retire encryption keys properly.' },
                    { id: '3.13.11', name: 'CUI Encryption', type: 'software',
                      req: 'Employ FIPS-validated cryptography when used to protect the confidentiality of CUI.',
                      meaning: 'Use FIPS 140-2 validated encryption modules for protecting CUI at rest and in transit.' },
                    { id: '3.13.12', name: 'Collaborative Device Control', type: 'policy',
                      req: 'Prohibit remote activation of collaborative computing devices and provide indication of devices in use.',
                      meaning: 'Disable remote activation of cameras/mics. Provide indicators when devices are active.' },
                    { id: '3.13.13', name: 'Mobile Code', type: 'mixed',
                      req: 'Control and monitor the use of mobile code.',
                      meaning: 'Control execution of JavaScript, ActiveX, macros. Block or prompt for untrusted mobile code.' },
                    { id: '3.13.14', name: 'Voice over Internet Protocol', type: 'config',
                      req: 'Control and monitor the use of Voice over Internet Protocol (VoIP) technologies.',
                      meaning: 'Secure VoIP systems. Monitor VoIP traffic. Apply same protections as data networks.' },
                    { id: '3.13.15', name: 'Communications Authenticity', type: 'config',
                      req: 'Protect the authenticity of communications sessions.',
                      meaning: 'Use session tokens, certificates to verify communication authenticity.' },
                    { id: '3.13.16', name: 'Data at Rest', type: 'software',
                      req: 'Protect the confidentiality of CUI at rest.',
                      meaning: 'Encrypt CUI stored on systems using FIPS-validated full-disk or file-level encryption.' },
                ]
            },
            'SYSTEM AND INFORMATION INTEGRITY (SI)': {
                id: 'si',
                count: 7,
                controls: [
                    { id: '3.14.1', name: 'Flaw Remediation', type: 'software',
                      req: 'Identify, report, and correct system flaws in a timely manner.',
                      meaning: 'Patch systems regularly. Prioritize critical security patches. Track patching status.' },
                    { id: '3.14.2', name: 'Malicious Code Protection', type: 'software',
                      req: 'Provide protection from malicious code at designated locations within organizational systems.',
                      meaning: 'Deploy antivirus/anti-malware on all endpoints and servers. Keep definitions updated.' },
                    { id: '3.14.3', name: 'Security Alerts & Advisories', type: 'policy',
                      req: 'Monitor system security alerts and advisories and take action in response.',
                      meaning: 'Subscribe to security alerts (US-CERT, vendor advisories). Act on relevant alerts.' },
                    { id: '3.14.4', name: 'Update Malicious Code Protection', type: 'config',
                      req: 'Update malicious code protection mechanisms when new releases are available.',
                      meaning: 'Enable automatic updates for antivirus signatures. Update definitions at least daily.' },
                    { id: '3.14.5', name: 'System & File Scanning', type: 'mixed',
                      req: 'Perform periodic scans of organizational systems and real-time scans of files from external sources.',
                      meaning: 'Run scheduled full system scans. Scan all downloads and email attachments in real-time.' },
                    { id: '3.14.6', name: 'Monitor Communications for Attacks', type: 'hardware',
                      req: 'Monitor organizational systems, including inbound and outbound communications traffic, to detect attacks.',
                      meaning: 'Deploy IDS/IPS. Monitor network traffic for indicators of attack. Alert on anomalies.' },
                    { id: '3.14.7', name: 'Identify Unauthorized Use', type: 'software',
                      req: 'Identify unauthorized use of organizational systems.',
                      meaning: 'Monitor for unauthorized access. Define acceptable use. Alert on policy violations.' },
                ]
            },
        };

        const TYPE_STYLES = {
            policy: { bg: '#2E86AB', label: 'Policy' },
            config: { bg: '#A23B72', label: 'Config' },
            software: { bg: '#F18F01', label: 'Software' },
            hardware: { bg: '#C73E1D', label: 'Hardware' },
            mixed: { bg: '#7B2D8E', label: 'Mixed' },
        };

        const DOMAIN_NAMES = Object.keys(CONTROLS);

        // ==================== STATE ====================
        let studiedControls = JSON.parse(localStorage.getItem('cmmc_studied') || '{}');
        let currentMode = 'study';
        let currentTypeFilter = 'all';
        let currentStudyFilter = 'all';
        let searchTerm = '';
        
        // Quiz state
        let quizType = 'multiple-choice';
        let questionCount = 20;
        let quizFocus = 'all';
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let correctAnswers = 0;
        let incorrectAnswers = 0;
        let answered = false;

        // ==================== UTILITY ====================
        function getAllControls() {
            const all = [];
            for (const [domain, data] of Object.entries(CONTROLS)) {
                for (const ctrl of data.controls) {
                    all.push({ ...ctrl, domain, domainId: data.id });
                }
            }
            return all;
        }

        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function saveProgress() {
            localStorage.setItem('cmmc_studied', JSON.stringify(studiedControls));
            updateProgressDisplay();
        }

        function updateProgressDisplay() {
            const total = 110;
            const studied = Object.keys(studiedControls).length;
            const percent = Math.round((studied / total) * 100);
            
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('studiedCount').textContent = studied;
            document.getElementById('remainingCount').textContent = total - studied;
        }

        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                studiedControls = {};
                saveProgress();
                renderDomains();
            }
        }

        // ==================== STUDY MODE ====================
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('studyModeBtn').classList.toggle('active', mode === 'study');
            document.getElementById('quizModeBtn').classList.toggle('active', mode === 'quiz');
            document.getElementById('studyContainer').classList.toggle('hidden', mode !== 'study');
            document.getElementById('quizContainer').classList.toggle('active', mode === 'quiz');
            document.getElementById('studyControls').style.display = mode === 'study' ? 'block' : 'none';
            document.getElementById('quizControls').style.display = mode === 'quiz' ? 'block' : 'none';
            
            if (mode === 'quiz') {
                showQuizSettings();
            }
        }

        function setTypeFilter(filter) {
            currentTypeFilter = filter;
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.toggle('active', item.dataset.filter === filter);
            });
            renderDomains();
        }

        function setStudyFilter(filter) {
            currentStudyFilter = filter;
            document.querySelectorAll('[data-study-filter]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.studyFilter === filter);
            });
            renderDomains();
        }

        function toggleStudied(controlId, checkbox) {
            if (checkbox.checked) {
                studiedControls[controlId] = true;
            } else {
                delete studiedControls[controlId];
            }
            saveProgress();
            
            // Update row styling
            const row = checkbox.closest('tr');
            row.classList.toggle('studied', checkbox.checked);
        }

        function renderDomains() {
            const container = document.getElementById('domainsContainer');
            container.innerHTML = '';
            let totalShowing = 0;
            
            for (const [domainName, domainData] of Object.entries(CONTROLS)) {
                const domain = document.createElement('div');
                domain.className = `domain domain-${domainData.id}`;
                
                const visibleControls = domainData.controls.filter(ctrl => {
                    const matchesType = currentTypeFilter === 'all' || ctrl.type === currentTypeFilter;
                    const isStudied = studiedControls[ctrl.id];
                    const matchesStudy = currentStudyFilter === 'all' || 
                        (currentStudyFilter === 'studied' && isStudied) ||
                        (currentStudyFilter === 'unstudied' && !isStudied);
                    const matchesSearch = searchTerm === '' || 
                        ctrl.id.toLowerCase().includes(searchTerm) ||
                        ctrl.name.toLowerCase().includes(searchTerm) ||
                        ctrl.req.toLowerCase().includes(searchTerm) ||
                        ctrl.meaning.toLowerCase().includes(searchTerm);
                    return matchesType && matchesStudy && matchesSearch;
                });
                
                totalShowing += visibleControls.length;
                
                if (visibleControls.length === 0 && (currentTypeFilter !== 'all' || currentStudyFilter !== 'all' || searchTerm !== '')) {
                    domain.style.display = 'none';
                }
                
                const studiedInDomain = domainData.controls.filter(c => studiedControls[c.id]).length;
                
                domain.innerHTML = `
                    <div class="domain-header" onclick="toggleDomain(this)">
                        <div>
                            <span class="domain-title">${domainName}</span>
                        </div>
                        <div class="domain-meta">
                            <span class="domain-progress">${studiedInDomain}/${domainData.count} studied</span>
                            <span class="domain-count">${visibleControls.length} shown</span>
                            <span class="domain-chevron">‚ñº</span>
                        </div>
                    </div>
                    <div class="domain-content">
                        <table class="controls-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%">‚úì</th>
                                    <th style="width: 13%">Control</th>
                                    <th style="width: 32%">Requirement</th>
                                    <th style="width: 35%">What It Means</th>
                                    <th style="width: 15%">Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${domainData.controls.map(ctrl => {
                                    const matchesType = currentTypeFilter === 'all' || ctrl.type === currentTypeFilter;
                                    const isStudied = studiedControls[ctrl.id];
                                    const matchesStudy = currentStudyFilter === 'all' || 
                                        (currentStudyFilter === 'studied' && isStudied) ||
                                        (currentStudyFilter === 'unstudied' && !isStudied);
                                    const matchesSearch = searchTerm === '' || 
                                        ctrl.id.toLowerCase().includes(searchTerm) ||
                                        ctrl.name.toLowerCase().includes(searchTerm) ||
                                        ctrl.req.toLowerCase().includes(searchTerm) ||
                                        ctrl.meaning.toLowerCase().includes(searchTerm);
                                    const hidden = (!matchesType || !matchesStudy || !matchesSearch) ? 'hidden' : '';
                                    const studiedClass = isStudied ? 'studied' : '';
                                    const style = TYPE_STYLES[ctrl.type];
                                    return `
                                        <tr class="${hidden} ${studiedClass}" data-type="${ctrl.type}">
                                            <td>
                                                <input type="checkbox" class="study-checkbox" 
                                                    ${isStudied ? 'checked' : ''} 
                                                    onchange="toggleStudied('${ctrl.id}', this)">
                                            </td>
                                            <td>
                                                <div class="control-id">${ctrl.id}</div>
                                                <div class="control-name">${ctrl.name}</div>
                                            </td>
                                            <td class="control-req">${ctrl.req}</td>
                                            <td class="control-meaning">${ctrl.meaning}</td>
                                            <td>
                                                <span class="impl-badge" style="background: ${style.bg}">${style.label}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.appendChild(domain);
            }
            
            document.getElementById('showingCount').textContent = totalShowing;
        }

        function toggleDomain(header) {
            header.parentElement.classList.toggle('collapsed');
        }

        // ==================== QUIZ MODE ====================
        function selectQuizType(type) {
            quizType = type;
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.quizType === type);
            });
        }

        function setQuestionCount(count) {
            questionCount = count;
            document.querySelectorAll('[data-q-count]').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.qCount) === count);
            });
        }

        function setQuizFocus(focus) {
            quizFocus = focus;
            document.querySelectorAll('[data-focus]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.focus === focus);
            });
        }

        function showQuizSettings() {
            document.getElementById('quizSettings').style.display = 'block';
            document.getElementById('quizCard').classList.remove('active');
            document.getElementById('flashcardCard').classList.remove('active');
            document.getElementById('quizResults').classList.remove('active');
        }

        function startQuiz() {
            let controls = getAllControls();
            
            if (quizFocus === 'unstudied') {
                controls = controls.filter(c => !studiedControls[c.id]);
            }
            
            if (controls.length === 0) {
                alert('No controls match your criteria. Try changing the focus settings.');
                return;
            }
            
            quizQuestions = shuffle(controls).slice(0, Math.min(questionCount, controls.length));
            currentQuestionIndex = 0;
            correctAnswers = 0;
            incorrectAnswers = 0;
            
            document.getElementById('quizSettings').style.display = 'none';
            document.getElementById('quizControls').style.display = 'block';
            
            updateQuizStats();
            
            if (quizType === 'flashcard') {
                showFlashcard();
            } else {
                showQuestion();
            }
        }

        function updateQuizStats() {
            document.getElementById('quizQuestionsCount').textContent = `${currentQuestionIndex + 1} / ${quizQuestions.length}`;
            document.getElementById('quizCorrectCount').textContent = correctAnswers;
            document.getElementById('quizIncorrectCount').textContent = incorrectAnswers;
        }

        function showQuestion() {
            const card = document.getElementById('quizCard');
            card.classList.add('active');
            document.getElementById('flashcardCard').classList.remove('active');
            
            const q = quizQuestions[currentQuestionIndex];
            answered = false;
            
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = quizQuestions.length;
            document.getElementById('correctScore').textContent = correctAnswers;
            document.getElementById('incorrectScore').textContent = incorrectAnswers;
            
            let questionLabel, questionText, questionSub, answers, correctAnswer;
            
            if (quizType === 'multiple-choice') {
                questionLabel = 'Which control matches this requirement?';
                questionText = q.name;
                questionSub = q.req;
                
                // Get 3 wrong answers from same domain if possible
                const otherControls = getAllControls().filter(c => c.id !== q.id);
                const wrongAnswers = shuffle(otherControls).slice(0, 3);
                answers = shuffle([q, ...wrongAnswers]);
                correctAnswer = q.id;
                
                document.getElementById('quizAnswers').innerHTML = answers.map(a => `
                    <div class="quiz-answer" data-answer="${a.id}" onclick="selectAnswer('${a.id}', '${correctAnswer}')">
                        <strong>${a.id}</strong> - ${a.meaning.substring(0, 80)}...
                    </div>
                `).join('');
                
            } else if (quizType === 'type-match') {
                questionLabel = 'What implementation type is this control?';
                questionText = `${q.id} - ${q.name}`;
                questionSub = q.meaning;
                
                const types = ['policy', 'config', 'software', 'hardware', 'mixed'];
                correctAnswer = q.type;
                
                document.getElementById('quizAnswers').innerHTML = types.map(t => `
                    <div class="quiz-answer" data-answer="${t}" onclick="selectAnswer('${t}', '${correctAnswer}')">
                        <span class="impl-badge" style="background: ${TYPE_STYLES[t].bg}">${TYPE_STYLES[t].label}</span>
                    </div>
                `).join('');
                
            } else if (quizType === 'domain-match') {
                questionLabel = 'Which domain does this control belong to?';
                questionText = `${q.id} - ${q.name}`;
                questionSub = q.meaning;
                
                const domains = shuffle(DOMAIN_NAMES).slice(0, 4);
                if (!domains.includes(q.domain)) {
                    domains[0] = q.domain;
                }
                correctAnswer = q.domain;
                
                document.getElementById('quizAnswers').innerHTML = shuffle(domains).map(d => `
                    <div class="quiz-answer" data-answer="${d}" onclick="selectAnswer('${d.replace(/'/g, "\\'")}', '${correctAnswer.replace(/'/g, "\\'")}')">
                        ${d}
                    </div>
                `).join('');
            }
            
            document.getElementById('questionLabel').textContent = questionLabel;
            document.getElementById('questionText').textContent = questionText;
            document.getElementById('questionSub').textContent = questionSub;
            document.getElementById('quizFeedback').classList.remove('show', 'correct', 'incorrect');
            document.getElementById('nextBtn').style.display = 'none';
        }

        function selectAnswer(selected, correct) {
            if (answered) return;
            answered = true;
            
            const isCorrect = selected === correct;
            if (isCorrect) {
                correctAnswers++;
            } else {
                incorrectAnswers++;
            }
            
            // Style answers
            document.querySelectorAll('.quiz-answer').forEach(el => {
                el.classList.add('disabled');
                if (el.dataset.answer === correct) {
                    el.classList.add('correct');
                } else if (el.dataset.answer === selected && !isCorrect) {
                    el.classList.add('incorrect');
                }
            });
            
            // Show feedback
            const feedback = document.getElementById('quizFeedback');
            feedback.classList.add('show', isCorrect ? 'correct' : 'incorrect');
            feedback.textContent = isCorrect ? '‚úì Correct!' : `‚úó Incorrect. The answer was: ${correct}`;
            
            document.getElementById('correctScore').textContent = correctAnswers;
            document.getElementById('incorrectScore').textContent = incorrectAnswers;
            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').textContent = 
                currentQuestionIndex < quizQuestions.length - 1 ? 'Next Question ‚Üí' : 'See Results';
            
            updateQuizStats();
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex >= quizQuestions.length) {
                showResults();
            } else {
                showQuestion();
            }
        }

        // ==================== FLASHCARD MODE ====================
        function showFlashcard() {
            document.getElementById('quizCard').classList.remove('active');
            document.getElementById('flashcardCard').classList.add('active');
            
            const q = quizQuestions[currentQuestionIndex];
            
            document.getElementById('fcCurrentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('fcTotalQuestions').textContent = quizQuestions.length;
            document.getElementById('fcControlId').textContent = q.id;
            document.getElementById('fcFront').textContent = q.name + ': ' + q.req;
            document.getElementById('fcBack').textContent = q.meaning;
            
            document.getElementById('flashcard').classList.remove('flipped');
            updateQuizStats();
        }

        function flipCard() {
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        function markFlashcard(gotIt) {
            if (gotIt) {
                correctAnswers++;
            } else {
                incorrectAnswers++;
            }
            
            currentQuestionIndex++;
            updateQuizStats();
            
            if (currentQuestionIndex >= quizQuestions.length) {
                showResults();
            } else {
                showFlashcard();
            }
        }

        // ==================== RESULTS ====================
        function showResults() {
            document.getElementById('quizCard').classList.remove('active');
            document.getElementById('flashcardCard').classList.remove('active');
            document.getElementById('quizResults').classList.add('active');
            
            const total = correctAnswers + incorrectAnswers;
            const percent = Math.round((correctAnswers / total) * 100);
            
            document.getElementById('resultsScore').textContent = percent + '%';
            document.getElementById('resultsCorrect').textContent = correctAnswers;
            document.getElementById('resultsIncorrect').textContent = incorrectAnswers;
            document.getElementById('resultsTotal').textContent = total;
            
            let icon, message;
            if (percent >= 90) {
                icon = 'üèÜ';
                message = 'Outstanding! You\'re exam ready!';
            } else if (percent >= 80) {
                icon = 'üéâ';
                message = 'Great job! Keep it up!';
            } else if (percent >= 70) {
                icon = 'üëç';
                message = 'Good progress! Review the missed ones.';
            } else if (percent >= 60) {
                icon = 'üìö';
                message = 'Keep studying! You\'re getting there.';
            } else {
                icon = 'üí™';
                message = 'Don\'t give up! Review and try again.';
            }
            
            document.getElementById('resultsIcon').textContent = icon;
            document.getElementById('resultsMessage').textContent = message;
        }

        function restartQuiz() {
            showQuizSettings();
        }

        function endQuiz() {
            if (confirm('Are you sure you want to end this quiz?')) {
                showQuizSettings();
            }
        }

        // ==================== SEARCH ====================
        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchTerm = e.target.value.toLowerCase();
            renderDomains();
        });

        // ==================== INIT ====================
        renderDomains();
        updateProgressDisplay();
        
        // ==================== MOBILE FUNCTIONS ====================
        function toggleMobileSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('show');
        }
        
        function closeMobileSidebar() {
            document.querySelector('.sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('show');
        }
        
        function mobileSetMode(mode) {
            setMode(mode);
            document.getElementById('mobileStudyBtn').classList.toggle('active', mode === 'study');
            document.getElementById('mobileQuizBtn').classList.toggle('active', mode === 'quiz');
            document.getElementById('mobileMenuBtn').classList.remove('active');
            closeMobileSidebar();
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const mobileNav = document.querySelector('.mobile-nav');
                if (!sidebar.contains(e.target) && !mobileNav.contains(e.target)) {
                    closeMobileSidebar();
                }
            }
        });
        
        // ==================== SERVICE WORKER ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered!', reg.scope))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>
